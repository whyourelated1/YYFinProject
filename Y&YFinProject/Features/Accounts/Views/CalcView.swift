/*Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ´ĞµĞ» ÑÑ‡ĞµÑ‚ Ğ½Ğ° SwiftUI https://www.figma.com/... Ğ² Ñ‚Ğ°Ğ±Ğ±Ğ°Ñ€
 
 ĞĞ° ÑĞºÑ€Ğ°Ğ½Ğµ "ĞœĞ¾Ğ¹ ÑÑ‡ĞµÑ‚" Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¾Ğ¼
 ĞĞ° ÑĞºÑ€Ğ°Ğ½Ğµ "ĞœĞ¾Ğ¹ ÑÑ‡ĞµÑ‚" Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ñ Ğ²Ğ°Ğ»ÑÑ‚Ğ¾Ğ¹
 Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ½Ğµ Ñ€ĞµĞ°Ğ»Ğ¸Ğ·Ğ¾Ğ²Ñ‹Ğ²Ğ°ĞµĞ¼
 ĞŸĞ¾ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ Ğ½Ğ° ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ" Ğ² Ğ½Ğ°Ğ²Ğ±Ğ°Ñ€Ğµ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
 ĞŸĞ¾ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ Ğ½Ğ° ÑÑ‡ĞµĞ¹ĞºÑƒ Ñ Ğ²Ğ°Ğ»ÑÑ‚Ğ¾Ğ¹ Ğ¿Ğ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ÑÑ Ğ¿Ğ¾Ğ¿Ğ°Ğ¿ ÑĞ¾ ÑĞ¿Ğ¸ÑĞºĞ¾Ğ¼ Ğ²Ğ°Ğ»ÑÑ‚ (https://www.figma.com/...). ĞŸÑ€Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞºÑ€Ğ°Ğ½. ĞŸÑ€Ğ¸ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ğ¸ Ğ½Ğ° ÑƒĞ¶Ğµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½ÑƒÑ Ğ²Ğ°Ğ»ÑÑ‚Ñƒ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ´ĞµĞ»Ğ°ĞµĞ¼.
 ĞŸĞ¾ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ Ğ½Ğ° ÑÑ‡ĞµĞ¹ĞºÑƒ Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¾Ğ¼ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ. ĞšĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ğ° Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ĞµÑ‚ÑÑ Ñ Ñ†Ğ¸Ñ„Ñ€Ğ°Ğ¼Ğ¸ Ğ¸ ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ ÑĞ²Ğ°Ğ¹Ğ¿Ğµ Ğ¿Ğ¾ ÑĞºÑ€Ğ°Ğ½Ñƒ.
 ĞŸĞ¾ Ğ½Ğ°Ğ¶Ğ°Ñ‚Ğ¸Ñ Ğ½Ğ° ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ" (https://www.figma.com/...) Ğ² Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ÑÑ Ğ² Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼
 Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞ¾ Ğ·Ğ²ĞµĞ·Ğ´Ğ¾Ñ‡ĞºĞ¾Ğ¹
 ĞĞ° ÑĞºÑ€Ğ°Ğ½ "ĞœĞ¾Ğ¹ ÑÑ‡ĞµÑ‚" Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ pull to refresh Ğ¸ Ğ¿Ñ€Ğ¾ĞºĞ¸Ğ½ÑƒÑ‚ÑŒ Ğ² Ğ¼Ğ¾Ğ´ĞµĞ»ÑŒ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….

 Ğ—Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ Ñ Ğ´Ğ²ÑƒĞ¼Ñ Ğ·Ğ²ĞµĞ·Ğ´Ğ¾Ñ‡ĞºĞ°Ğ¼Ğ¸
 Ğ¡ĞºÑ€Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¸ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¿Ğ¾ Ñ‚Ñ€ÑÑĞºĞµ Ğ´ĞµĞ²Ğ°Ğ¹ÑĞ°. Ğ¡ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° ÑĞ´ĞµĞ»Ğ°Ñ‚ÑŒ Ñ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¾Ğ¼ Ğ°Ğ½Ğ¸Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¿Ğ¾Ğ¹Ğ»ĞµÑ€Ğ° (ĞºĞ°Ğº Ğ² Telegram).
 Ğ”Ğ°Ñ‚ÑŒ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ Ğ²ÑÑ‚Ğ°Ğ²Ğ»ÑÑ‚ÑŒ Ğ±Ğ°Ğ»Ğ°Ğ½Ñ Ğ¸Ğ· Ğ±ÑƒÑ„ĞµÑ€Ğ° Ğ¾Ğ±Ğ¼ĞµĞ½Ğ° Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½ĞµĞ²Ğ°Ğ»Ğ¸Ğ´Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ° ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹
*/
import SwiftUI
import Combine
import SwiftData
import Foundation
enum Currency: String, CaseIterable, Identifiable {
    case rub = "RUB"
    case usd = "USD"
    case eur = "EUR"
    
    var id: Self { self }
    
    var displayName: String {
        switch self {
        case .rub: return "Ğ Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¸Ğ¹ Ñ€ÑƒĞ±Ğ»ÑŒ â‚½"
        case .usd: return "ĞĞ¼ĞµÑ€Ğ¸ĞºĞ°Ğ½ÑĞºĞ¸Ğ¹ Ğ´Ğ¾Ğ»Ğ»Ğ°Ñ€ $"
        case .eur: return "Ğ•Ğ²Ñ€Ğ¾ â‚¬"
        }
    }
    
    var symbol: String {
        switch self {
        case .rub: return "â‚½"
        case .usd: return "$"
        case .eur: return "â‚¬"
        }
    }
}
@MainActor
final class CalcViewModel: ObservableObject {
    @Published var bankAccount: BankAccount?
    @Published var editingBalance: String = ""
    @Published var editingCurrency: String = ""
    @Published private(set) var isLoading: Bool = false
    @Published var alertMessage: String? = nil
    @Environment(\.editMode) private var editMode

    private var bankAccountService: BankAccountsService?
    private var modelContainer: ModelContainer

    init(modelContainer: ModelContainer) {
        self.modelContainer = modelContainer
    }

    var formatedBalance: String {
        guard let account = bankAccount else { return "0 $" }
        return "\(account.balance) \(account.currencySymbol)"
    }

    func loadBankAccount() async {
        if bankAccountService == nil {
            guard
                let baseURL = APIKeysStorage.shared.getBaseURL(),
                let token = APIKeysStorage.shared.getToken()
            else {
                self.alertMessage = "ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Ğº API"
                return
            }
            let network = NetworkService(baseURL: baseURL, token: token, session: .shared)
            self.bankAccountService = BankAccountsService(network: network, modelContainer: modelContainer)
        }

        isLoading = true
        defer { isLoading = false }

        guard let bankAccountService else {
            alertMessage = "Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ° Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½"
            return
        }

        do {
            let account = try await bankAccountService.get()
            self.bankAccount = account
            self.editingBalance = String(describing: account.balance)
            self.editingCurrency = account.currencySymbol
        } catch {
            self.alertMessage = error.localizedDescription
        }
    }

    func saveChanges() async {
        isLoading = true
        defer { isLoading = false }

        guard let bankAccountService = bankAccountService,
              let account = bankAccount else { return }

        let updatedAccount = BankAccount(
            id: account.id,
            userId: account.userId,
            name: account.name,
            balance: Decimal(string: editingBalance) ?? account.balance,
            currency: editingCurrency,
            createdAt: account.createdAt,
            updatedAt: Date()
        )

        do {
            self.bankAccount = try await bankAccountService.update(updatedAccount)
        } catch {
            self.alertMessage = error.localizedDescription
        }
    }

    func refresh() {
        Task {
            isLoading = true
            defer { isLoading = false }

            guard let bankAccountService = bankAccountService else { return }

            do {
                var updatedAccount = try await bankAccountService.get()
                try? await Task.sleep(nanoseconds: 1_500_000_000)

                if let newBalance = Decimal(string: self.editingBalance) {
                    updatedAccount.balance = newBalance
                }

                updatedAccount.currency = currencyCode(for: editingCurrency)

                _ = try await bankAccountService.update(updatedAccount)

                self.bankAccount = updatedAccount
                self.editingBalance = String(describing: updatedAccount.balance)
                self.editingCurrency = updatedAccount.currencySymbol
            } catch {
                self.alertMessage = error.localizedDescription
            }
        }
    }

    private func currencyCode(for symbol: String) -> String {
        switch symbol {
        case "$": return "USD"
        case "â‚¬": return "EUR"
        case "â‚½": return "RUB"
        default: return "RUB"
        }
    }

    func filterBalanceInput(_ input: String) -> String {
        let allowedCharacters = CharacterSet(charactersIn: "0123456789.")
        let filteredScalars = input.unicodeScalars.filter { allowedCharacters.contains($0) }
        var filtered = String(String.UnicodeScalarView(filteredScalars))

        var separatorCount = 0
        filtered = filtered.filter { char in
            if char == "." {
                separatorCount += 1
                return separatorCount == 1
            }
            return true
        }

        if filtered.count > 1 && filtered.first == "0" {
            let secondChar = filtered[filtered.index(after: filtered.startIndex)]
            if secondChar != "." {
                filtered = String(filtered.drop { $0 == "0" })
            }
        }

        if filtered.isEmpty {
            filtered = "0"
        }

        return filtered
    }

    func dismissAlert() {
        alertMessage = nil
    }
}


struct CalcView: View {
    @Environment(\.editMode) private var editMode
    @StateObject var viewModel: CalcViewModel
    @State private var isEditing = false
    @State private var showCurrencyPicker = false
    @FocusState private var balanceFieldFocused: Bool
    init(modelContainer: ModelContainer) {
        _viewModel = StateObject(wrappedValue: CalcViewModel(modelContainer: modelContainer))
    }
    var body: some View {
        ScreenContainer(title: "ĞœĞ¾Ğ¹ ÑÑ‡ĞµÑ‚") {
            VStack(alignment: .leading, spacing: 20) {
                //Ğ±Ğ°Ğ»Ğ°Ğ½Ñ
                HStack {
                    HStack(spacing: 8) {
                        Text("ğŸ’°")
                        Text("Ğ‘Ğ°Ğ»Ğ°Ğ½Ñ")
                    }
                    Spacer()
                    if isEditing {
                        HStack(spacing: 4) {
                            TextField("0", text: _viewModel.balance)
                                .keyboardType(.decimalPad)
                                .focused($balanceFieldFocused)
                                .multilineTextAlignment(.trailing)
                                .foregroundColor(.black)
                                .onChange(of: _viewModel.balance) {_, newValue in
                                    let filtered = newValue.filter { "0123456789.".contains($0) }
                                    let parts = filtered.split(separator: ".")
                                    let cleaned: String
                                    if parts.count > 1 {
                                        cleaned = parts[0] + "." + parts[1..<parts.count].joined()
                                    } else {
                                        cleaned = filtered
                                    }
                                    if cleaned != newValue {
                                        _viewModel.balance = cleaned
                                    }
                                }
                            Text(_viewModel.currency.symbol)
                        }
                    } else {
                        HStack(spacing: 4) {
                            Text(_viewModel.balance)
                                .onShake {
                                    withAnimation { _viewModel.isBalanceHidden.toggle() }
                                }
                            Text(_viewModel.currency.symbol)
                        }
                    }
                }
                .padding(.vertical, 10)
                .padding(.horizontal, 15)
                .background(isEditing ? Color.white : Color("Accent"))
                .cornerRadius(12)
                .onTapGesture {
                    if isEditing {
                        balanceFieldFocused = true
                    }
                }
                //Ğ²Ğ°Ğ»ÑÑ‚Ğ°
                HStack {
                    Text("Ğ’Ğ°Ğ»ÑÑ‚Ğ°")
                        .font(.body)
                    Spacer()
                    Text(_viewModel.currency.symbol)
                        .font(.body)
                    if _viewModel.isEditing {
                        Image(systemName: "chevron.right")
                    }
                }
                .padding(.vertical, 10)
                .padding(.horizontal, 15)
                .background(_viewModel.isEditing ? Color.white : Color("Accent").opacity(0.15))
                .cornerRadius(12)
                .onTapGesture {
                    guard _viewModel.isEditing else { return }
                    showCurrencyPicker = true
                }
                .accentColor(.indigo)
                .confirmationDialog(
                    "Ğ’Ğ°Ğ»ÑÑ‚Ğ°",
                    isPresented: $showCurrencyPicker
                ) {
                    ForEach(Currency.allCases) { cur in
                        Button(cur.displayName) {
                            if cur != _viewModel.currency {
                                _viewModel.currency = cur
                            }
                        }
                        .foregroundColor(.indigo)
                    }
                }
            }
            .padding(.horizontal, 16)
        }
        .toolbar {
            ToolbarItem(placement: .navigationBarTrailing) {
                Button(isEditing ? "Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ" : "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ") {
                    withAnimation {
                        if isEditing {
                            editMode?.wrappedValue = .inactive
                            balanceFieldFocused = false
                        } else {
                            editMode?.wrappedValue = .active
                            balanceFieldFocused = true
                        }
                        _viewModel.isEditing.toggle()
                    }
                }
                .foregroundColor(.indigo)
            }
        }
        .refreshable {
            await viewModel.refresh()
        }
    }
}


